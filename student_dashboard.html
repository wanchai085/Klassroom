{% extends "base.html" %}
{% block title %}‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ {{ request.user.fname|default:"" }}</h1>

{# ‚îÄ‚îÄ ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‚îÄ‚îÄ #}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
  {% for s in stats %}
    <a href="{{ s.href|default:'#' }}" class="block card rounded-2xl p-5 hover:shadow-md transition">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-lg">{{ s.icon }}</div>
        <div>
          <p class="text-sm text-slate-500">{{ s.title }}</p>
          <p class="text-xl font-semibold">{{ s.value }}</p>
          {% if s.cta %}<p class="mt-1 text-xs text-indigo-600">{{ s.cta }}</p>{% endif %}
        </div>
      </div>
    </a>
  {% endfor %}
</div>

{# Progress ring (‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà view ‡πÉ‡∏´‡πâ: submitted / my_assignments) #}
{% if stats and stats|length >= 3 %}
  <div class="card p-6 mb-8">
    <div class="flex items-center gap-6">
      <div id="progRing" class="relative w-24 h-24">
        <div id="progBg" class="absolute inset-0 rounded-full" style="background: conic-gradient(#e5e7eb 0 100%)"></div>
        <div class="absolute inset-1 bg-white rounded-full flex items-center justify-center">
          <span id="progText" class="text-lg font-semibold text-slate-700">0%</span>
        </div>
      </div>
      <div class="text-sm text-slate-600">
        <p class="font-semibold mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</p>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤ ‚Äú‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß / ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
      </div>
    </div>
  </div>
{% endif %}

{# ‚îÄ‚îÄ Floating Chat (‡∏ö‡∏≠‡∏ó‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤) ‚îÄ‚îÄ #}
<div id="chatbot-window"
     class="fixed bottom-16 right-4 w-96 h-[500px] bg-[#242526] text-white rounded-xl shadow-2xl flex flex-col hidden z-50">
  <div class="flex items-center justify-between px-3 py-2 bg-[#3a3b3c] rounded-t-xl">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center">ü§ñ</div>
      <p class="font-semibold">‡∏ö‡∏≠‡∏ó‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤</p>
    </div>
    <button type="button" onclick="toggleChat()" class="hover:text-red-400 text-lg">‚úñ</button>
  </div>

  <div id="chat-internal" class="flex-1 p-3 space-y-4 overflow-y-auto bg-[#18191a] text-sm leading-relaxed"></div>

  <!-- Quick Replies -->
  <div class="flex gap-2 p-2 border-t border-gray-700 bg-[#2a2b2c]">
    <button type="button" class="px-3 py-1 rounded-full bg-indigo-600 text-white text-xs" onclick="quickAsk('‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á')">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á</button>
    <button type="button" class="px-3 py-1 rounded-full bg-indigo-600 text-white text-xs" onclick="quickAsk('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô')">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
    <button type="button" class="px-3 py-1 rounded-full bg-indigo-600 text-white text-xs" onclick="quickAsk('‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á')">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á</button>
  </div>

  <form id="form-internal" class="flex items-center gap-2 p-3 bg-[#3a3b3c] rounded-b-xl">
    <input id="input-internal" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‚Äù ..."
           class="flex-1 rounded-full px-4 py-2 bg-[#4e4f50] text-white placeholder-gray-300 outline-none">
    <button type="submit" class="px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">‚û§</button>
  </form>
</div>

<button id="chat-toggle-btn" type="button" onclick="toggleChat()"
        class="fixed bottom-4 right-4 bg-indigo-600 text-white rounded-full w-14 h-14 shadow-lg hover:bg-indigo-700 flex items-center justify-center text-2xl z-50">
  üí¨
</button>
{% endblock %}

{% block extra_js %}
<script>
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const UID = "{{ request.user.id|default:0 }}";
  const CID = "{{ enrollments.0.course.id|default:0 }}";
  const KEY_INT = `chat_history_internal_${UID}_${CID}`;

  const form = document.getElementById("form-internal");
  const input = document.getElementById("input-internal");
  const chat = document.getElementById("chat-internal");

  // Ring
  (function ring(){
    // ‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà 3 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: value ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "x/y"
    const cards = document.querySelectorAll('.card .text-xl.font-semibold');
    let ratioText = null;
    cards.forEach(el => { if (/\d+\s*\/\s*\d+/.test(el.textContent.trim())) ratioText = el.textContent.trim(); });
    if (!ratioText) return;
    const [a,b] = ratioText.split('/').map(s => parseInt(s,10) || 0);
    const pct = b ? Math.round((a/b)*100) : 0;
    document.getElementById('progBg').style.background = `conic-gradient(#4f46e5 ${pct*3.6}deg, #e5e7eb 0)`;
    document.getElementById('progText').textContent = `${pct}%`;
  })();

  function toggleChat() {
    const win = document.getElementById("chatbot-window");
    const btn = document.getElementById("chat-toggle-btn");
    win.classList.toggle("hidden");
    btn.classList.toggle("hidden");
    if (!win.classList.contains("hidden")) restoreChat();
  }

  function bubbleUser(container, text) {
    const el = document.createElement("div");
    el.className = "flex justify-end";
    el.innerHTML = `<div class="bg-indigo-600 text-white rounded-2xl px-4 py-2 max-w-[70%] shadow whitespace-pre-line">${escapeHtml(text)}</div>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    saveChat();
  }

  function bubbleBotText(container, text) {
    const el = document.createElement("div");
    el.className = "flex items-start gap-2";
    el.innerHTML = `
      <div class="w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-sm">ü§ñ</div>
      <div class="bg-[#3a3b3c] text-white rounded-2xl px-4 py-2 max-w-[75%] shadow whitespace-pre-line">
        ${escapeHtml(text)}
      </div>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    saveChat();
  }

  function bubbleBotHTML(container, html) {
    const el = document.createElement("div");
    el.className = "flex items-start gap-2";
    el.innerHTML = `
      <div class="w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-sm">ü§ñ</div>
      <div class="bg-[#3a3b3c] text-white rounded-2xl px-4 py-2 max-w-[75%] shadow space-y-2">
        ${html}
      </div>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    saveChat();
  }

  function bubbleTyping(container) {
    const el = document.createElement("div");
    el.className = "bot-typing flex items-start gap-2";
    el.innerHTML = `<div class="w-7 h-7 rounded-full bg-indigo-500 flex items-center justify-center text-sm">ü§ñ</div>
      <div class="bg-[#3a3b3c] text-white rounded-2xl px-4 py-2 shadow typing-dots">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</div>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    return el;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
    ));
  }

  function saveChat() { localStorage.setItem(KEY_INT, chat.innerHTML); }
  function restoreChat() {
    const saved = localStorage.getItem(KEY_INT);
    if (saved && saved.trim()) {
      chat.innerHTML = saved;
    } else {
      bubbleBotText(chat,
        "üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n\n"+
        "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô:\n"+
        "‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á\n"+
        "‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô\n"+
        "‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô\n"+
        "‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á\n"+
        "‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"
      );
    }
  }

  async function askBot(text) {
    bubbleUser(chat, text);
    input.value = "";
    const typingEl = bubbleTyping(chat);
    try {
      const res = await fetch("{% url 'chatbot_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({ message: text, course_id: CID })
      });
      const data = await res.json();
      typingEl.remove();

      if (data.is_html) {
        bubbleBotHTML(chat, data.reply);
      } else {
        bubbleBotText(chat, data.reply);
      }
    } catch (err) {
      typingEl.remove();
      bubbleBotText(chat, "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
    }
  }

  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    const text = (input.value || "").trim();
    if (text) askBot(text);
  });

  function quickAsk(text){ askBot(text); }

  restoreChat();
</script>

<style>
.typing-dots::after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
@keyframes dots {
  0%, 20% { content: ' .'; }
  40% { content: ' ..'; }
  60% { content: ' ...'; }
  80%, 100% { content: ''; }
}
</style>
{% endblock %}
